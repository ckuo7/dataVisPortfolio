<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Information Visualization Portfolio</title>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-theme.min.css" rel="stylesheet">

<style type="text/css">
    body {
        padding-top: 50px;
        padding-bottom: 20px;
    }
</style>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63845252-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
<!-- Fixed Navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index.html">Portfolio</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
            <!--<ul class="nav navbar-nav">-->
                <!--<li><a href="#homework">Homework</a></li>-->
                <!--<li><a href="#project">Project</a></li>-->
                <!--<li><a href="#participation">Participation</a></li>-->
            <!--</ul>-->

            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://msan695ckuo7.appspot.com/">Home</a></li>
                <li><a href="http://msan695ckuo7.appspot.com/about">About</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class = "container">
<div>

    <h2>Introduction</h2>

    In this project, I built a movie recommendation dashboard using the <a href="http://docs.ggplot2.org/0.9.3.1/movies.html">movies</a>
    dataset from <a href="http://ggplot2.org/">ggplot2</a> package in R. It has three interactive visualizations for users
    to explore the movie dataset. The first one is the vertical barchart on the left hand side, which sorts movies
    by their ratings in descending order. So, user can easily find movies with the highest ones. The second visualization
    is the donut chart on the top right hand side, which shows the proportions of each genre in a given year.
    The last one is the line chart below the donut chart, which is slightly irrelevant in this context but it shows
    the trend of the average budget for making a movie in a particular genre over time.

    <h2>Navigation</h2>
    <ul>

        <li><b>Filter 1:</b> click the drop-down list to select movies in a particular year</li>
        <li><b>Filter 2:</b> click the donut chart to select movies by genres and also view the average budget over time.</li>
        <li><b>Detail on demand:</b> hover the bar to see the detail information of the movie</li>
    </ul>
    <!--It has two filter function to help you select movies. The First one is the . The second one is the donut chart on the top right-->
    <!--hand side where you-->


        <!--<h2><a href="https://public.tableau.com/views/prototype_0/Dashboard1?:embed=y&:showTabs=y&:display_count=yes">Tableau Prototype</a></h2>-->
        <!--<h2>Data Preprocessing</h2>-->
        <!--<p>I did most of my data preprocessing in R to create three separate csv files for my plots. For donut and line chart, I aggregated number of movies and average-->
            <!--budgets by different genres and years. For the bar chart, I used the original dataset. The preprocessing facilitated data preparation in D3 so that browsers-->
            <!--can render my visualization more quickly.-->
        <!--</p>-->
        <!--<h2>Basic Functionality</h2>-->
        <!--<ul>-->
            <!--<li>A horizontal bar chart sorted by ratings of movies (rows: title, column: year)</li>-->
            <!--<li>A pie chart (category: year, measure: percentage. I don't know how to make a donut in tableau so I made a pie instead)</li>-->
            <!--<li>A line chart (rows: year, columns: budget)</li>-->
        <!--</ul>-->
        <!--<h2>Moderate Functionality</h2>-->
        <!--<ul>-->
            <!--<li>A horizontal bar chart with ratings on x axis and titles as y axis</li>-->
            <!--<li>A donut chart with genres as categories and percentage as angles</li>-->
            <!--<li>A line chart with time as x axis and average budgets as y axis</li>-->
        <!--</ul>-->
        <!--<h2>Advanced Functionality</h2>-->
        <!--<ul>-->
            <!--<li>Filtering movies of different years by the drop-down list</li>-->
            <!--<li>Filtering movies of different genres by clicking segments of donut chart</li>-->
            <!--<li>Filtering average budget of different genres by clicking segments of donut chart</li>-->
        <!--</ul>-->
        <!--<h2>User Guide</h2>-->
        <!--<p>-->
            <!--W-->
            <!--just too difficult to find a right one. So, I decided to use this dataset to build up a movie recommendation dashboard.-->

            <!--After selecting a year, the barchart would automatically sort by-->
    <!--ratings of movies that belongs to the selected year in descending order. Then we can easily know which ones have highest ratings in a given year. Detail information about a movie is provided when its bar is hovered.-->
    <!--This is achived by clicking different segments of donut chart. For example, if you want to check romance movies, just click the orange segment!-->
    <!--This interactivity provides users an easy and quick access to all the highest rated movies of different genre of a given year. In addition,-->
    <!--the line chart, which shows the average budgets for making movies of corresponding genre, would also change if we click the segments.-->


        </p>
        <div id ="start"></div>
        <h2><a href="#start">Get Started</a></h2>

</div>
<style>
    svg {
    background-color: white;
    margin: 1px;
    float: left;
    }

.inner {
    width: 1150px;
    height: 600px;
    overflow: auto;
}
#dashboard{
    width: 1600px;
    height: 1600px;
    overflow: scroll;
}
path.slice{
	stroke-width:2px;
}
polyline{
	opacity: .3;
	stroke: black;
	stroke-width: 2px;
	fill: none;
}
.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
.bar {
  opacity: 1;
}

.bar:hover {
  opacity: 0.5 ;
}
</style>
<ul id = "filter">

    <script>
        var select = document.createElement("select");
        select.setAttribute("id","selectYear");
        var dropDownList = document.getElementById("filter");
        dropDownList.appendChild(select);
        d3.csv('./data/moviesYear.csv', function(d){ return d.year;}, function(error,data){
            data.forEach( function(d){

                var option = document.createElement("option");

                option.setAttribute("value",d);
                var textnode = document.createTextNode(d);
                option.appendChild(textnode);
                select.appendChild(option);
            });
        })
    </script>
    <!--<select name="tpi" id="genre">-->
        <!--<option selected="selected" value="none">none</option>-->
        <!--<option value="action">action</option>-->
        <!--<option value="animation">animation</option>-->
        <!--<option value="comedy">comedy</option>-->
        <!--<option value="drama">drama</option>-->
        <!--<option value="documentary">documentary</option>-->
        <!--<option value="romance">romance</option>-->
        <!--<option value="short">short</option>-->
      <!--</select>-->
</ul>

<div id="chart1" class="inner">
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <!--<script>-->
        <!--var select = document.createElement("select");-->
        <!--select.setAttribute("id","selectYear");-->
        <!--var dropDownList = document.getElementById("chart1");-->
        <!--dropDownList.appendChild(select);-->
        <!--d3.csv('../data/moviesYear.csv', function(d){ return d.year;}, function(error,data){-->
            <!--data.forEach( function(d){-->

                <!--var option = document.createElement("option");-->

                <!--option.setAttribute("value",d);-->
                <!--var textnode = document.createTextNode(d);-->
                <!--option.appendChild(textnode);-->
                <!--select.appendChild(option);-->
            <!--});-->
<!--//            console.log(select);-->
<!--//            dropDownList.appendChild(select);-->
        <!--})-->
    <!--</script>-->

    <script>



    var margin = {top: 40, right: 20, bottom: 30, left: 200},
        width = 400 - margin.left - margin.right,
        height = 6000 - margin.top - margin.bottom,
        radius = 150;

    var svg = d3.select("#chart1").append('svg').attr("width",1600);
//            .attr("height", (height + margin.top + margin.left));

    var frameRect = d3.select('svg').append('rect').attr('width',1130).style("fill","none").style("stroke","gray");


    var chart1 = d3.select('svg').append('g').attr("id","barGroup");

    var xScale = d3.scale.linear().range([0, width]).domain([0,10]);

    var xAxis = d3.svg.axis().scale(xScale).orient("top").ticks(10);

    var xGuide = chart1.append("g").attr("class", "x axis").attr("id", "axis").call(xAxis);
    xGuide.selectAll('line').style({"fill": "none", "stroke": "black"});
    xGuide.selectAll('path').style({"fill": "none", "stroke": "black"});
    xGuide.append("text").attr("x", width+15).attr("dy",-9).text("Rating");


    var movieData = [];
    var uniqueYear = [];

    var donut = svg.append("g");
    donut.append("text").text("2005")
                    .attr("text-anchor","middle")
                    .attr("id","textYear")
                    .attr("dy",5)
                    .style({"font-family":"georgia, serif", "font-size":40, "font-weight":"bold","fill":"silver"});

    donut.append("g").attr("class", "slices");
    donut.append("g").attr("class", "labels");
    donut.append("g").attr("class", "lines");

    var pie = d3.layout.pie()
	    .sort(null)
	    .value(function(d) {
		    return d.value;
	        });

    var arc = d3.svg.arc()
	    .outerRadius(radius * 0.8)
	    .innerRadius(radius * 0.4);

    var outerArc = d3.svg.arc()
	    .innerRadius(radius * 0.9)
	    .outerRadius(radius * 0.9);

    donut.attr("transform", "translate(800," + (radius + 30) + ")");


    var key = function(d){
//        console.log(d);
        return d.data.label; };

    var color = d3.scale.ordinal()
	    .domain(["action","animation","comedy","drama","documentary","romance","short"])
//	    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        .range(["#8DD3C7", "#FFFFB3", "#BEBADA", "#FB8072", "#80B1D3", "#FDB462", "#B3DE69"]);

    var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
            return "<strong>Title:</strong> <span style='color:red'>" + d.title + "</span><br>" +
                    "<strong>Rating:</strong> <span style='color:red'>" + d.rating+ "</span><br>" +
                    "<strong>Length:</strong> <span style='color:red'>" + d.length + " mins" + "</span><br>" +
                    "<strong>MPAA:</strong> <span style='color:red'>" + d.mpaa + "</span>";;
            });
    chart1.call(tip);

    var width3 = 450, height3 = 150;
    var xScale3 = d3.time.scale().range([0,width3]);
    var yScale3 = d3.scale.linear().range([height3,0]);
    var color3 = d3.scale.category10();
    var xAxis3 = d3.svg.axis().scale(xScale3).orient("bottom");
    var format3 = d3.format("$,d");
    var yAxis3 = d3.svg.axis().scale(yScale3).orient("left").tickFormat(format3).ticks(5);

    function value(d){return d.value;}
    var line3 = d3.svg.line().interpolate("basis")
            .x(function(d){ return xScale3(d.year);})
            .y(function(d){ return yScale3(value(d));});

    var lineChart = svg.append("g")
//        .attr("width", width + margin.left + margin.right)
//        .attr("height", height + margin.top + margin.bottom)
//
            .attr("transform", "translate(600," + (radius*2 + 50) + ")");
    var parseYear = d3.time.format("%Y").parse;




function plotLine(){

    d3.csv('./data/moviesBudget.csv',function(d){
        return {    "year": parseYear(d.year),
//                    "action": +d.action,
//                    "animation": +d.animation,
//                    "comedy": +d.comedy,
//                    "drama": +d.drama,
//                    "documentary": +d.documentary,
//                    "romance": +d.romance,
//                    "short": +d.short,
//                    "total": +d.total
                    "value": +d.total
                    };
    }, function(error,data){

        console.log(error);
        console.log(data);

        xScale3.domain(d3.extent(data, function(d) {return d.year;}));
        yScale3.domain([0,57000000]);

        var xGuide3 = lineChart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height3 + ")")
            .call(xAxis3);

        var yGuide3 = lineChart.append("g")
            .attr("class", "y axis")
            .call(yAxis3);
//            .append("text")
//            .attr("transform", "rotate(-90, 0," + height3 + ")")
//            .attr("y", height3)
//            .attr("x", 75)
//            .attr("dy", "1.1em")
//            .style("text-anchor", "end")
//            .text("Temperature (ÂºF)"); // rotate along the center

        yGuide3.selectAll('line').style({"fill": "none", "stroke": "black"});
        yGuide3.selectAll('path').style({"fill": "none", "stroke": "black"});
        xGuide3.selectAll('line').style({"fill": "none", "stroke": "black"});
        xGuide3.selectAll('path').style({"fill": "none", "stroke": "black"});

        xGuide3.append('text').attr("x",width3).attr("dy",18).text("Year");
        yGuide3.append('text').text("Budget").attr("dx",-10).attr("text-anchor","end");

        var budget = lineChart.append("path").datum(data)
                .attr("id", "linechart")
                .attr("d", line3)
                .style("stroke", function(d) { return color3(d.value); })
                .style({"fill":"none","stroke-width":2});
        console.log(data[data.length-1]["year"]);
        console.log(yScale3(data[data.length-1]["value"]));
        lineChart.append("text")
            .attr("id","lineLabel")
            .attr("transform", "translate(" + width3 + "," + yScale3(data[data.length-1]["value"]) + ")")
            .attr("x", 3)
            .attr("dy", ".35em")
            .text("total");


    });
    }

function updateLine(genre_){
    console.log(genre_);
    d3.csv('./data/moviesBudget.csv',function(d){
        return {    "year": parseYear(d.year),

                    "value": +d[genre_]
                    };
    }, function(error,data){

    d3.select("#linechart").datum(data).transition().duration(1000).attr("d",line3);
    d3.select("#lineLabel").transition().duration(800).attr("transform", "translate(" + width3 + "," + yScale3(data[data.length-1]["value"]) + ")").text(genre_)
    });

}

function plotDonut(){

    var sYear = +document.getElementById("selectYear").value;
    var sYear_ = sYear === 0 ? 2005 : sYear;
    console.log(sYear);
    d3.csv("./data/movieGenreYear.csv",
        function(d){
                return {
                    "year": +d.year,
                    "action": +d.action,
                    "animation": +d.animation,
                    "comedy": +d.comedy,
                    "drama": +d.drama,
                    "documentary": +d.documentary,
                    "romance": +d.romance,
                    "short": +d.short,
                    "sum" : +d.sum };
        },
        function(error,data){

            var data_ = [];
            var sum_ = null;
            data.forEach(function(d){
                if(d.year===sYear_){
                    console.log(d);
                    data_.push({"label":"action","value":d.action});
                    data_.push({"label":"animation","value":d.animation});
                    data_.push({"label":"comedy","value":d.comedy});
                    data_.push({"label":"drama","value": d.drama});
                    data_.push({"label":"documentary","value":d.documentary});
                    data_.push({"label":"romance","value":d.romance});
                    data_.push({"label":"short","value":d.short});
                    sum_ = d.sum;}});

//            console.log(data_);
//            console.log(sum_);


            console.log(error);
            console.log(pie(data_));

            var slice = donut.select(".slices").selectAll("path.slice").data(pie(data_), key);
//            console.log(slice);

            slice.enter()
                .insert("path")
                .style("fill", function(d) { return color(d.data.label); })
                .attr("class", "slice")
                    .on('mouseover',function(d){

                        d3.select(this).style("opacity","0.6");
                    })
                    .on('mouseout', function(d){

                        d3.select(this).style("opacity",1);
                    })
                    .on('click', function(d){

                        console.log(d.data.label);
                        plotBar(d.data.label);
                        updateLine(d.data.label);
                    });

            slice.transition().duration(1000)
                .attrTween("d", function(d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        return arc(interpolate(t));
                    };
                });

        	slice.exit().remove();


            var text = donut.select(".labels").selectAll("text")
		        .data(pie(data_), key);

            text.enter()
                .append("text")
                .attr("dy", ".35em")
                .text(function(d) {
//                        return d.data.label + "(" + Math.round(d.value/sum_*100) + "%)";
                        return d.data.label ;
                });

            function midAngle(d){
                return d.startAngle + (d.endAngle - d.startAngle)/2;
            }

            text.transition().duration(1000)
                .attrTween("transform", function(d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
                        return "translate("+ pos +")";


                    };
                })
                .styleTween("text-anchor", function(d){
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        return midAngle(d2) < Math.PI ? "start":"end";
                    };
                });

            text.exit()
                .remove();


            var polyline = donut.select(".lines").selectAll("polyline")
                .data(pie(data_), key);

            polyline.enter()
                .append("polyline");

            polyline.transition().duration(2000)
                .attrTween("points", function(d){
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
                        return [arc.centroid(d2), outerArc.centroid(d2), pos];
                    };
                });

            polyline.exit()
                .remove();

            d3.select("#textYear").transition().duration(400).text(document.getElementById("selectYear").value);
        }
    );}



function plotBar(genre_) {
        console.log(genre_);
        d3.selectAll(".bar").remove();
        d3.select("#yAxis").remove();
//        var chart1 = d3.select('svg').append('g').attr("id","barGroup");
        d3.csv("./data/moviesWhole.csv",

                function (d) {

                    return {
                        "title": d.title,
                        "year": +d.year,
                        "length": +d.Length,
                        "budget": +d.budget,
                        "mpaa": d.mpaa,
                        "votes": +d.votes,
                        "rating": +d.rating,
                        "action": +d.Action,
                        "animation": +d.Animation,
                        "comedy": +d.Comedy,
                        "drama": +d.Drama,
                        "documentary": +d.Documentary,
                        "romance": +d.Romance,
                        "short": +d.Short
                    };
                },

                function (error, data) {
                    console.log(error);

//                    console.log(document.getElementById("selectYear").value);
                    var sYear = +document.getElementById("selectYear").value;


//                    var mGenre = genre_ === undefined ? document.getElementById("genre").value : genre_ ;
                    var mGenre = genre_ === undefined ? "none" : genre_ ;

//                    console.log(sYear);
//                    console.log(mGenre);

                    var data_ = [];

                    if (mGenre === "none") {
                        data.forEach(function (d) {
                            if (d.year === sYear) {
                                data_.push(d);
                            }
                        });
                    }
                    else{
                        data.forEach(function (d) {
                            if (d.year === sYear && d[mGenre] === 1) {
                                data_.push(d);
                            }
                        });

                    }


                    var sortData_ = data_.sort(function (a, b) {
                        return a.rating - b.rating;}).reverse();
                    var numOfMovies = sortData_.length;

                    console.log(numOfMovies);
                    var height_ = numOfMovies*30 < 900 ? 900 : numOfMovies*30 ;
                    svg.attr("height",height_);
                    frameRect.attr('height',height_);
                    var yScale = d3.scale.ordinal().rangeBands([0, height_],.1,.3);
                    var yAxis = d3.svg.axis().scale(yScale).orient("left");


                    var leftmargin = d3.max(sortData_, function (d) {
                        return d.title.length;
                    });
//                    console.log(leftmargin);
                    chart1.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//                    console.log(sortData_);

                    yScale.domain(sortData_.map(function (d) {
                        return d.title;
                    }));
                    chart1.selectAll('rect').data(sortData_).enter().append("rect")
                            .attr('class', "bar")
                            .attr("x", 0)
                            .attr("y", function (d) {
                                return yScale(d.title);
                            })
                            .attr("width", 0)
//                    .attr("width",function(d){
//                        console.log(xScale(d.rating));
//                        return xScale(d.rating);})
                            .attr("height", yScale.rangeBand())
                            .style("fill", "#80B1D3")
                            .on("mouseover", tip.show)
                            .on("mouseout", tip.hide);


                    d3.selectAll(".bar").data(sortData_)
                            .transition().duration(400).delay(function (d, i) {
                                return 50 * i;
                            })
                            .attr("width", function (d) {
                                return xScale(d.rating);
                            });
//            })
//            .attr("y", function (d) {
//                return (y(d.frequency))
//            });




                    var yGuide = chart1.append("g")
                            .attr("class", "y axis")
                            .attr("id", "yAxis")
                            .call(yAxis);


                    yGuide.selectAll('line').style({"fill": "none", "stroke": "none"});
                    yGuide.selectAll('path').style({"fill": "none", "stroke": "none"});


//            console.log(uniqueYear);
////            data.forEach(function(d){
////
////                movieData.push(d);})
//            var years = {};
//            for (var i = 0; i < year.length; i++) {
//                if (year[i] in years) {years[year[i]]++;}
//                else {years[year[i]] = 1;}}
//
//            uniqueYear = Object.keys(years).sort().reverse();
//            console.log(uniqueYear);
//
//            uniqueYear.forEach( function(d){
//
//                var option = document.createElement("option");
//
//                        option.setAttribute("value",d);
//                var textnode = document.createTextNode(d);
//                        option.appendChild(textnode);
//                select.appendChild(option);
//            });
//            console.log(select);
//            dropDownList.appendChild(select);

                });
    }

        document.getElementById("selectYear").onchange = plotDashboard;
//        document.getElementById("genre").onchange = plotBar;

function plotDashboard(){

        plotDonut();
        plotBar();


    }

        plotLine();
        plotBar();
        plotDonut();
        frameRect.on('click',updateLine("total"));
    </script>
    <ul>
    </ul>
</div>
</div>
</body>