<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>MSAN 622 Homework2</title>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-theme.min.css" rel="stylesheet">

<style type="text/css">
    body {
        padding-top: 50px;
        padding-bottom: 20px;
    }
</style>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.min.js"></script>
</head>

<body>
<!-- Fixed Navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">MSAN 622</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#homework">Homework</a></li>
                <li><a href="#project">Project</a></li>
                <li><a href="#participation">Participation</a></li>
            </ul>

            <ul class="nav navbar-nav navbar-right">
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class = "container">
    <h2>Time Series Plot</h2>
    <ul>
        <li><b>Basic Functionality:</b> Line plot</li>
        <li><b>Moderate Functionality:</b> Panning on brushed window, Detail-on-Demand</li>
        <li><b>Advanced Functionality:</b> Brushing, Filtering</li>
    </ul>
    <div id="chart1" width="2200" height="640">
        <select name="tpi" id="xxxxx">
        <!--<option value="driversKilled">driversKilled</option>-->
        <option selected="selected" value="drivers">drivers</option>
        <option value="front">front</option>
        <option value="rear">rear</option>
        <option value="vanKilled">vanKilled</option>
        <option value="kms">kms</option>
        <option value="petrolPrice">petrolPrice</option>
        <option value="law">law</option>
      </select>

        <style>

svg {
  font: 14px sans-serif;
}

.area {
  fill: steelblue;
  clip-path: url(#clip);
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.focus . area{ fill:steeblue;}
.context . area{ fill:tomato;}
/*more specific*/

.brush .extent {
  stroke: red;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

</style>
        <script>

var parseDate = d3.time.format("%Y-%m-%d").parse;
var title = {
                        "diversKilled" : "Drivers Killed",
                        "drivers" : "Drivers Killed",
                        "front" : "Front-seat passengers killed or seriously injured",
                        "rear" : "Rear-seat passengers killed or seriously injured.",
                        "kms" : "Distance driven.",
                        "petrolPrice" : "Petrol Price.",
                        "vanKilled" : "Number of van (‘light goods vehicle’) drivers.",
                        "law" : "Was the law in effect that month?"};
var ylabel = {
                        "diversKilled" : "Drivers Killed",
                        "drivers" : "Toll",
                        "front" : "Toll",
                        "rear" : "Toll",
                        "kms" : "",
                        "petrolPrice" : "",
                        "vanKilled" : "Toll",
                        "law" : ""};
function plot(){

    console.log(document.getElementById("xxxxx").value);
    d3.select("#mainSVG").remove();

var selected = document.getElementById("xxxxx").value;


var margin = {top: 60, right: 20, bottom: 120, left: 70},
    margin2 = {top: 250, right: 120, bottom: 20, left: 70},
    width = 960 - margin.left - margin.right,
    height = 330 - margin.top - margin.bottom,
    height2 = 300 - margin2.top - margin2.bottom;

//


var xScale = d3.time.scale().range([0, width]),
    xScale2 = d3.time.scale().range([0, width]),
    yScale = d3.scale.linear().range([height, 0]),
    yScale2 = d3.scale.linear().range([height2, 0]); // scale from the top

var xAxis = d3.svg.axis().scale(xScale).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(xScale2).orient("bottom"),
    yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(3);

var bisectDate = d3.bisector(function(d) { return d.date; }).left;
// brush control along the x direction

var brush = d3.svg.brush()
    .x(xScale2)
    .on("brush", brushed);  // gets or sets the listener for the specified event type, the first
                            // element is evenet listener " can be "brushstart, brush, brushend"
                            // when event happened call the brushed function

//var selected = document.getElementById("xxxxx").value;

function brushed() {

    xScale.domain( brush.empty() ? xScale2.domain() : brush.extent());
    // reset the xScale domain to brush range
    // if brush is empty return every thing, new domain of brush
    focus1.select("#line").attr("d", line1);
    focus1.select(".xAxis").call(xAxis);
}

var svg = d3.select("#chart1").append("svg").attr("id","mainSVG")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

    svg.append("rect")
            .attr("width",width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom).style("fill","none").style("stroke","gray");

svg.append("defs").append("clipPath")
    .attr("id", "clip")
  .append("rect")
    .attr("width", width)
    .attr("height", height);

svg.append("text").text(title[selected]).style("text-anchor", "middle").attr("x",width/2 + margin.left).attr("y",30)
        .attr("font-size", "24px");
var focus1 = svg.append("g")
    .attr("class", "focus")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var context1 = svg.append("g")
    .attr("class", "context")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");




var line1 = d3.svg.line()
    .interpolate("basis") // smoothing method
    .x(function(d) { return xScale(d.date); }) // look at the x
//    .y(function(d) { return yScale(d.front); });
    .y(function(d) { return yScale(d[selected]); });

var line2 = d3.svg.line()
    .interpolate("basis") // smoothing method
    .x(function(d) { return xScale2(d.date); }) // look at the x
//    .y(function(d) { return yScale2(d.front); });
    .y(function(d) { return yScale2(d[selected]); });


var area1 = d3.svg.area()
    .interpolate("monotone") // use the generator function to generate the data for you
    .x(function(d) { return xScale(d.date); })
    .y0(height)
//    .y1(function(d) { return yScale(d.front); });
    .y1(function(d) { return yScale(d[selected]); });

var area2 = d3.svg.area()
    .interpolate("monotone") // use the generator function to generate the data for you
    .x(function(d) { return xScale2(d.date); })
    .y0(height2)
//    .y1(function(d) { return yScale2(d.front); });
    .y1(function(d) { return yScale2(d[selected]); });



d3.csv("./data/seatbelts.csv",

        function(d){

            return {    "date" : parseDate(d.date),
                        "diversKilled" : +d.DriversKilled,
                        "drivers" : +d.drivers,
                        "front" : +d.front,
                        "rear" : +d.rear,
                        "kms" : +d.kms,
                        "petrolPrice" : +d.PetrolPrice,
                        "vanKilled" : +d.VanKilled,
                        "law" : +d.law};},

        function(error, data) {

                console.log(data);
        // scale function is the setter if received argument, getter if it's empty
//        xScale.domain(d3.extent(data.map(function(d) { return d.date; })));
//        yScale.domain([0, d3.max(data.map(function(d) { return d.front; }))]);
        xScale.domain(d3.extent(data.map(function(d) { return d.date; })));
        yScale.domain([0, d3.max(data.map(function(d) {
//            console.log(selected);
//            console.log(d);
//            console.log(d['driversKilled']);
//            console.log(d['drivers']);
            return d[selected]; }))]);

        xScale2.domain(xScale.domain());
        yScale2.domain(yScale.domain());

        var xGuide1 = focus1.append("g")
            .attr("class", "xAxis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

            xGuide1.select("path").style({"fill":"none","stroke":"black"});
            xGuide1.selectAll("line").style({"fill":"none"});



        var yGuide1 = focus1.append("g")
            .attr("class", "y axis")
            .call(yAxis);

            yGuide1.append('text').text(ylabel[selected]).attr("x",-35);
            xGuide1.append('text').text("Time").attr("x",width - 30).attr("y",-5);
//            var xGuide = context1.append('g').attr("transform","translate(" + margin.left "," + margin.top + height + margin)
//        focus1.append("path") // draw area
//            .datum(data)
//            .attr("class", "area")
//            .attr("d", area1);

        focus1.append("path")
                .datum(data).attr("id","line").attr("d",line1).style({"fill":"none","stroke":"steelblue","stroke-width":2}).style("clip-path","url(#clip)");

//        focus1.append("g")
//            .attr("class", "xAxis")
//            .attr("transform", "translate(0," + height + ")")
//            .call(xAxis);

        focus1.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        context1.append("path")
              .datum(data)
              .attr("class", "line")
              .attr("d", line2).style({"fill":"none","stroke":"black","stroke-width":2});

        var xGuide2 = context1.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height2 + ")")
              .call(xAxis2);

        context1.append("g")
            .attr("class", "x brush")
            .call(brush) // call the brush function
            .selectAll("rect")
            .attr("y", -6) // shift the
            .attr("height", height2 + 7);

//            begin tooltip

        var focusDot = focus1.append("g").style("display","none");
            focusDot.append("circle").attr("r",5).style("fill","steelblue").style("strok","white");
            focusDot.append("text").attr("x",10).attr("dy", ".35em").style("font-size",16);

        focus1.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all")
        .on("mouseover", function() { focusDot.style("display", null); })
        .on("mouseout", function() { focusDot.style("display", "none"); })
        .on("mousemove", mousemove);



        function mousemove() {
//            console.log(d3.mouse(this));
            var x0 = xScale.invert(d3.mouse(this)[0]),

            i = bisectDate(data, x0, 1),
            d0 = data[i - 1],
            d1 = data[i],
            d = x0 - d0.date > d1.date - x0 ? d1 : d0;
//            console.log(x0);
//            console.log("ii");
//            console.log(i);
//            focusDot.attr("transform", "translate(" + xScale(d.date) + "," + yScale(d.front) + ")");
              focusDot.attr("transform", "translate(" + xScale(d.date) + "," + yScale(d[selected]) + ")");
//            focusDot.select("text").text(d.front);
            focusDot.select("text").text(d[selected]);
  }
        });

    };
plot();
document.getElementById("xxxxx").onchange = plot;
</script>
    </div>

    <div id="chart2" width="2200" height="640">
    <h2>Cal-Heat Map</h2>
    <ul>
    <li><b>Basic Functionality:</b> Calendar Heat Map</li>
    <li><b>Moderate Functionality:</b> Zooming, Panning, Dragging, and Detail-on-Demand</li>
    </ul>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script >
//var parseDate = d3.time.format("%Y-%m-%d").parse;

var margin3 = { top: 50, right: 0, bottom: 100, left: 30 },
    width3 = 960 - margin3.left - margin3.right,
    height3 = 280 - margin3.top - margin3.bottom,
    gridSize = Math.floor(width3 / 50),
    legendElementWidth = gridSize*3,
    buckets = 9,
    colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"], // alternatively colorbrewer.YlGnBu[9]
    days = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],
    times = ["1a", "2a", "3a", "4a", "5a", "6a", "7a", "8a", "9a", "10a", "11a", "12a", "1p", "2p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p", "11p", "12p"];

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 10])
    .on("zoom", zoomed);

var svg3 = d3.select("#chart2").append("svg")
              .attr("width", width3 + margin3.left + margin3.right)
              .attr("height", height3 + margin3.top + margin3.bottom);
var svg3g1 = svg3.append("g")
              .attr("transform", "translate(" + (margin3.left + 30) +"," + margin3.top + ")").call(zoom);

    svg3.append('rect')
        .attr("width", width3 + margin3.left + margin3.right)
        .attr("height", height3 + margin3.top + margin3.bottom).style("fill","none").style("stroke","gray");

var heatMapGroup = svg3g1.append("g");

var monthName = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var feature = ["driversKilled","drivers","front","rear"];




function zoomed() {
            heatMapGroup.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");

}

d3.csv("./data/seatbelts.csv",

        function(d) {
          return {
                  "driversKilled" : +d.DriversKilled,
                  "drivers" : +d.drivers,
                  "front" : +d.front,
                  "rear" : +d.rear,
                  "kms": +d.kms,
                  "petrolprice": +d.PetrolPrice,
                  "vanKilled" : +d.VanKilled,
                  "law" : +d.law,
                  "date" : parseDate(d.date)
          };
        },
        function(error, data) {

            // append new svg
            console.log("second chart")
            console.log(data);
            var newData = [];
            for ( i in data){
                newData.push(data[i].driversKilled);
                newData.push(data[i].drivers);
                newData.push(data[i].front);
                newData.push(data[i].rear);
            }
//            console.log(newData);
//            console.log(data[13].date.getMonth());

//            console.log(data.map(function(d){return d.driversKilled, d.drivers, d.front, d.rear;}));

            console.log(newData);
            var colorScale = d3.scale.quantile()
//              .domain([0, buckets - 1, d3.max(newData)])
                    .domain(d3.extent(newData))
//                            , function (d) { return d.driverKilled; })])
              .range(colors);

            console.log("colorScale.domain");
            console.log(colorScale.domain());

            var legend = svg3g1.selectAll(".legend")
              .data([0].concat(colorScale.quantiles()), function(d) { return d; })
              .enter().append("g")
              .attr("class", "legend");

            var heatmap = heatMapGroup.selectAll(".square")
              .data(newData)
              .enter().append("rect")
              .attr("x", function(d,i) { return Math.floor(i/4)* gridSize; })
//                  .attr("x", 30)
//              .attr("y", function(d,i) { return i * gridSize; })
              .attr("y", function(d,i){ return (i%4)*gridSize})
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", "hour bordered")
              .attr("width", gridSize)
              .attr("height", gridSize)
              .style("fill", colors[0]).style("stroke","gray")
              .on('mouseover', function(d){

                  var tooltip = legend.append("text")
                            .attr("id", "tooltip")
                            .attr("x", legendElementWidth * 9.8)
                            .attr("y", height3 + margin3.top + gridSize - 3)
//                            .attr("text-anchor", "middle")
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "14px")
//                            .attr("font-weight", "bold")
                            .attr("fill","red")
                            .text(d + "people"); })


              .on('mouseout',function(d){

                            legend.select("#tooltip").remove();
                    });



          heatmap.transition().duration(2000)
              .style("fill", function(d) {
//                            console.log(colorScale(d));
                            return colorScale(d); });



            heatMapGroup.selectAll(".month").data(data).enter().append("text").attr("x", function(d,i) { return i * gridSize; }).attr("y", -5)
                    .text(function(d){return monthName[d.date.getMonth()];}).style("font-size",8);

            heatMapGroup.selectAll(".year").data(data).enter().append("text").attr("x", function(d,i) { return i * gridSize; }).attr("y", -20)
                    .text(function(d,i){
                        if (i%12==0){return d.date.getYear();}
                        else { return "";}});

            heatMapGroup.selectAll(".label").data(feature).enter().append("text").attr("x", -5).attr("y", function(d,i){ return (i+0.7)*gridSize})
                    .text(function(d){return d}).style("font-size",8).style("text-anchor","end");


//
          legend.append("rect")
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height3 + margin3.top)
            .attr("width", legendElementWidth )
            .attr("height", gridSize )
            .style("fill", function(d, i) { return colors[i]; });
//
          legend.append("text")
            .attr("class", "mono")
            .text(function(d) { return "≥ " + Math.round(d); }).style("font-size",14)
            .attr("x", function(d, i) { return legendElementWidth  * i; })
            .attr("y", height3 + margin3.top + 30);

            legend.append("text").attr("x", legendElementWidth * 9 + 5).attr("y", height3 + margin3.top + gridSize - 3).text("Toll:");

      });
    </script>
    </div>
    <div>
    <h2>Design Guide</h2>
        <p>
            Seatbelts dataset has 8 variables in total. Each one of them has very different domain range, making it very difficult to visualize them all in one plot. So, I created a drop down
            list to sort of filtering the data and just plot one variable at a time. To increase the explorability of my line chart, I added an overview at the bottom to maintain the context and
            created a brushing function so that more focus can be applied to the main one. I chose the "basis" method to interpolate the line path, which makes the whole visualization
            a lot smoother than other methods. However, the trade-off is introducing more lie-factor in the chart. Hence, I created a blue dot to indicate the exact value of variable when mouse is in
            the plotting region.<br><br>
            For the cal-heatmap, I implemented zooming and dragging functionality on it so that users can resize the chart and drag to the part that they are interested. Also, to provide more detail
            on each block, I added a fixed tooltip besides the color scale to indicate the actual number for each data point.

        </p>
    <h2>Reference</h2>
        <ul>
            <li><a href="http://bl.ocks.org/mbostock/1667367">focus+context</a></li>
            <li><a href="http://www.d3noob.org/2014/07/my-favourite-tooltip-method-for-line.html">tooltip for line chart</a> </li>
            <li><a href="http://bl.ocks.org/tjdecke/5558084">calendar heatmap</a> </li>
            <li><a href="http://bl.ocks.org/mbostock/6123708">drag and zoom</a></li>
        </ul>
    </div>
</body>
</html>